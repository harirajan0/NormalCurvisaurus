---
title: "Datathon Slide Template"
author: "Rebecca C. Steorts"
date: September 27 2018
output: 
     beamer_presentation:
      includes: 
          in_header: slide-template/custom2.tex
          

font-size: 12px
---
```{r, echo=FALSE}
#Load necessary packages
library("magrittr")
library("tidyr")
library("ggplot2")
```

```{r, echo=FALSE}
#Reading in the data
user_data = read.csv('data/user_profile.csv')
summary(user_data)

#Removing columns that are redundant and cover the same information
data.pre = user_data[-c(1, 3, 4, 5, 27, 28, 36)]

#ishomeowner, gender(remove unisex), remove NA from 8, 9, 10, 27, 28
data.pre = subset(data.pre, (data.pre$gender == 'Male' | data.pre$gender == 'Female'))
data.pre= na.omit(data.pre)
data.pre$gender = data.pre$gender == 'Female'
data.pre$is_homeowner = data.pre$is_homeowner == 'True'
cols <- sapply(data.pre, is.logical)
data.pre[,cols] <- lapply(data.pre[,cols], as.numeric)

#turning the buckets into continous values - we average the bucket's min & max to the middle value

#cor(data.pre[-1])

decode_bucket <- function(fctr) {
  fctr <- gsub("[()]", '', fctr)
  fctr <- gsub("\\]", '', fctr)
  bounds <- strsplit(fctr, ", ")
  return(mean(as.numeric(bounds[[1]])))
}
data.pre$age = unlist(lapply(data.pre$age_bucket, FUN = decode_bucket))
data.pre$credit_score = unlist(lapply(data.pre$credit_score_bucket, FUN = decode_bucket))
data.pre = na.omit(data.pre)

#removing bucketed columns
data.pre = data.pre[-c(31,32)]

#reading in user engagement data
user_engage_data = read.csv('data/user_engagement.csv')

#We are taking the click counts for differnt types of pages
user_engage_actions = user_engage_data[c(21, 22, 23, 24, 25, 26)]
```

Data set
===

- The data was from Credit Sesame, a company that calculates credit scores to determine options for credit cards, mortgage rates and loans. This dataset included: 
      -User Demographics - credit profile information including loan histories, tradeline details, etc, and a few personal features such as gender and location
      -First Session Information - action logs of each user's first interaction with the Credit Sesame website
      -30-day User Engagement Data - insight into the actions of users in each one's first 30 days which included various logins for each user

Dislay of Data Through Initial Exploration
===
```{r}
#Plot histogram of each column in user_data
data.pre %>% gather() %>% head()
ggplot(gather(data.pre[seq(2,15)]), aes(value)) + 
    geom_histogram(bins=10) + 
    facet_wrap(~key, scales = 'free_x')
ggplot(gather(data.pre[seq(16,31)]), aes(value)) + 
    geom_histogram(bins=10) + 
    facet_wrap(~key, scales = 'free_x')
``` 

Exploring the Dataset 
===
- Started EDA by looking at the distribution of each of the variables in the dataset, as shown in the previous slide.
- Almost all the non-categorical data was heavily skewed to the right.
- Many variables had high frequency for lower values and significantly lower frequency for higher values
- Only non-cateogrical variables not heavily skewed were `age` and `credit_score`. 

This was important to keep in mind as we proceeded in our analysis as the distribution of each variable can impact the results of our analysis methods.


Challenges of the Dataset
===

- The skewed distribution of our variables was the biggest challenge for determining how to analyze this data.
- Ultimately we did not let the skew effect our methods but were careful to consider it in our analysis.

Methods
===

- We used several methods: PCA, Regression Analysis, and k-means clusterng
- Our most successful method was the k-means clustering
- To evalute this method, we compared how the data differed between the clusters

Results
===

- After determining the number of clusters to use and accordingly performing the k-means clustering method, we noticed that in particular, there were two clusters which had relatively high values for `click_count_credit_card` and `click_count_personal_loan`, respectively as shown below:
```{r, echo=FALSE}
k.max <- 20
data <- user_engage_actions
wss <- sapply(1:k.max, 
              function(k){kmeans(data, k, nstart=50,iter.max = 15 )$tot.withinss})
#ploting the wws vs. number of clusters. 
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares")

set.seed(10)
kmeanclusters = kmeans(user_engage_actions, 8, nstart=20)
kmeanclusters$centers

```


Results (continued)
===

- The users that were grouped into these two clusters had a noticeably large difference in the mean values for several different variables as shown below. Note that these variable values generally correspond to the user's frewuent actions on the Credit Sesame website.
```{r, echo=FALSE}
#from the clustering, we can see that there are two clusters with larger values in particular columns (see report for interpretation). We want the user IDs of the people who had the inflated column values. 
click_credit_card = user_engage_data[which(kmeanclusters$cluster == 7),]
click_personal_loan = user_engage_data[which(kmeanclusters$cluster == 4),]

#creating a subset of user demographics that relate to the people with inflated column values
click_credit_users = subset(data.pre, data.pre$user_id %in% click_credit_card$user_id)
click_loan_users = subset(data.pre, data.pre$user_id %in% click_personal_loan$user_id)

#comparing the user demographics of the two groups of people
options(scipen=999)
#add this to the appendix
compare = matrix(c(mean(click_credit_users$is_homeowner), mean(click_loan_users$is_homeowner),
                   mean(click_credit_users$gender), mean(click_loan_users$gender),
                   mean(click_credit_users$tradelines_avg_days_since_opened), mean(click_loan_users$tradelines_avg_days_since_opened),
                   mean(click_credit_users$tradelines_max_days_since_opened), mean(click_loan_users$tradelines_max_days_since_opened),
                   mean(click_credit_users$tradelines_min_days_since_opened), mean(click_loan_users$tradelines_min_days_since_opened),
                   mean(click_credit_users$count_tradelines_closed_accounts), mean(click_loan_users$count_tradelines_closed_accounts),
                   mean(click_credit_users$count_total_tradelines_opened_24_months), mean(click_loan_users$count_total_tradelines_opened_24_months),
                   mean(click_credit_users$count_tradelines_cc_opened_24_months), mean(click_loan_users$count_tradelines_cc_opened_24_months),
                   mean(click_credit_users$count_tradelines_condition_derogatory), mean(click_loan_users$count_tradelines_condition_derogatory),
                   mean(click_credit_users$count_open_installment_accounts_24_months), mean(click_loan_users$count_open_installment_accounts_24_months),
                   mean(click_credit_users$count_tradelines_open_collection_accounts), mean(click_loan_users$count_tradelines_open_collection_accounts),
                   mean(click_credit_users$count_tradelines_open_mortgages), mean(click_loan_users$count_tradelines_open_mortgages),
                   mean(click_credit_users$count_tradelines_open_student_loans), mean(click_loan_users$count_tradelines_open_student_loans),
                   mean(click_credit_users$count_tradelines_opened_accounts), mean(click_loan_users$count_tradelines_opened_accounts),
                   mean(click_credit_users$count_tradelines_open_secured_loans), mean(click_loan_users$count_tradelines_open_secured_loans),
                   mean(click_credit_users$count_tradelines_open_unsecured_loans), mean(click_loan_users$count_tradelines_open_unsecured_loans),
                   mean(click_credit_users$total_tradelines_amount_past_due), mean(click_loan_users$total_tradelines_amount_past_due),
                   mean(click_credit_users$total_open_cc_amount_past_due), mean(click_loan_users$total_open_cc_amount_past_due),
                   mean(click_credit_users$total_cc_open_balance), mean(click_loan_users$total_cc_open_balance),
                   mean(click_credit_users$total_tradelines_open_balance), mean(click_loan_users$total_tradelines_open_balance),
                   mean(click_credit_users$max_cc_limit), mean(click_loan_users$max_cc_limit),
                   mean(click_credit_users$total_mortgage_loans_amount), mean(click_loan_users$total_mortgage_loans_amount),
                   mean(click_credit_users$total_mortgage_loans_balance), mean(click_loan_users$total_mortgage_loans_balance),
                   mean(click_credit_users$total_auto_loans_balance), mean(click_loan_users$total_auto_loans_balance),
                   mean(click_credit_users$total_student_loans_balance), mean(click_loan_users$total_student_loans_balance),
                   mean(click_credit_users$count_inquiries_3_months), mean(click_loan_users$count_inquiries_3_months),
                   mean(click_credit_users$count_inquiries_6_months), mean(click_loan_users$count_inquiries_6_months),
                   mean(click_credit_users$count_inquiries_12_months), mean(click_loan_users$count_inquiries_12_months),
                   mean(click_credit_users$count_bankruptcy), mean(click_loan_users$count_bankruptcy),
                   mean(click_credit_users$age), mean(click_loan_users$age),
                   mean(click_credit_users$credit_score), mean(click_loan_users$credit_score)),ncol = 2, byrow = TRUE)


compare = matrix(c(
                   mean(click_credit_users$count_tradelines_condition_derogatory), mean(click_loan_users$count_tradelines_condition_derogatory),
                   mean(click_credit_users$count_tradelines_open_collection_accounts), mean(click_loan_users$count_tradelines_open_collection_accounts),
                   mean(click_credit_users$total_tradelines_amount_past_due), mean(click_loan_users$total_tradelines_amount_past_due),
                   mean(click_credit_users$total_open_cc_amount_past_due), mean(click_loan_users$total_open_cc_amount_past_due),
                   mean(click_credit_users$total_cc_open_balance), mean(click_loan_users$total_cc_open_balance),
                   mean(click_credit_users$total_tradelines_open_balance), mean(click_loan_users$total_tradelines_open_balance),
                   mean(click_credit_users$max_cc_limit), mean(click_loan_users$max_cc_limit),
                   mean(click_credit_users$total_mortgage_loans_amount), mean(click_loan_users$total_mortgage_loans_amount),
                   mean(click_credit_users$total_mortgage_loans_balance), mean(click_loan_users$total_mortgage_loans_balance),
                   mean(click_credit_users$total_auto_loans_balance), mean(click_loan_users$total_auto_loans_balance),
                   mean(click_credit_users$credit_score), mean(click_loan_users$credit_score)),ncol = 2, byrow = TRUE)

colnames(compare) = c("click_credit", "click_loan")
rownames(compare) = names(click_credit_users[-c(1,2,3,4,5,6,7,8,9,11,13,14,15,16,17,26,27,28,29,30,31)])
compare
```

Conclusions
===

- Our PCA and Linear Regression Analysis both support the conclusion that longer opened accounts and higher credit card limits are two of the strongest indicators of credit scores. Additionally, homeowner status and number of accounts turned over to collection agencies as strong predictors of credit score.
- Our k-means clustering concluded that Credit Sesame's website clientele that use the credit card links are different from the people who used the website for loans.
- Future Work: Moving fowards, we can work to improve the current models that we used. For example, our regression model could've been improved using other regression methods such as Lasso or ElasticNet so we wouldn't have to do feature selection by hand. Additionally, we could've tried clustering by usuing hierarchical clustering to see if we could get more informative results. 